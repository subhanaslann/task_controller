// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Role values: ADMIN | TEAM_MANAGER | MEMBER | GUEST
// - ADMIN: System-wide admin (for platform management)
// - TEAM_MANAGER: Organization owner/manager (can manage their org users)
// - MEMBER: Regular team member
// - GUEST: Limited access user

model Organization {
  id        String   @id @default(uuid())
  name      String   // Company name
  teamName  String   // Team name
  slug      String   @unique // URL-friendly identifier
  isActive  Boolean  @default(true)
  maxUsers  Int      @default(15) // Per-org user limit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users  User[]
  tasks  Task[]
  topics Topic[]

  @@index([slug])
  @@index([isActive])
}

model User {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  username       String
  email          String
  passwordHash   String
  avatar         String?  // Base64 encoded avatar image
  role           String   @default("MEMBER") // ADMIN | TEAM_MANAGER | MEMBER | GUEST
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedTasks     Task[]             @relation("AssignedTasks")
  accessibleTopics  GuestTopicAccess[]

  @@unique([organizationId, username])
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
}

model Topic {
  id             String   @id @default(uuid())
  organizationId String
  title          String
  description    String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        Task[]
  guestAccess  GuestTopicAccess[]

  @@index([organizationId])
  @@index([isActive])
}

model Task {
  id             String    @id @default(uuid())
  organizationId String
  topicId        String?
  title          String
  note           String?
  assigneeId     String?
  status         String    @default("TODO") // TODO, IN_PROGRESS, DONE (mapped to TODO|DOING|DONE for API)
  priority       String    @default("NORMAL") // LOW, NORMAL, HIGH
  dueDate        DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  completedAt    DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  topic        Topic?       @relation(fields: [topicId], references: [id], onDelete: SetNull)
  assignee     User?        @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([topicId])
  @@index([assigneeId])
  @@index([status])
}

model GuestTopicAccess {
  id        String   @id @default(uuid())
  userId    String
  topicId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([topicId])
}
